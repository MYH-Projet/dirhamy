// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum TypeCompte {
  Cash
  Banque
}

enum TypeTransaction {
  DEPENSE
  REVENU
  TRANSFER
}

model Utilisateur {
  id           Int     @id @default(autoincrement())
  nom          String
  prenom       String
  email        String  @unique
  motDePasse   String
  refreshToken String?

  // Relationships
  comptes    Compte[]
  categories Categorie[]
}

model Compte {
  id   Int        @id @default(autoincrement())
  nom  String
  type TypeCompte

  // Foreign Key
  utilisateurId Int
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id])

  // Relationships
  transactionsSent     Transaction[] @relation("SourceAccount")
  transactionsReceived Transaction[] @relation("DestinationAccount")

  snapshots BalanceSnapshot[]
}

model Categorie {
  id    Int    @id @default(autoincrement())
  nom   String
  limit Float?

  // Foreign Key
  utilisateurId Int
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id])

  // Relationships
  transactions Transaction[]
  snapshots    BudgetSnapshot[]

  @@unique([id, nom])
}

model BudgetSnapshot {
  id        Int      @id @default(autoincrement())
  monthDate DateTime // Store as 1st of the month (e.g., 2025-12-01T00:00:00Z)
  limit     Float // The budget set for this month
  spend     Float    @default(0) // The calculated total spent (Cached)

  categorieId Int
  categorie   Categorie @relation(fields: [categorieId], references: [id])

  // Ensure unique snapshot per category per month
  @@unique([categorieId, monthDate])
}

model Transfer {
  id           Int           @id @default(autoincrement())
  createdAt    DateTime      @default(now())
  // This relation links to the transactions
  transactions Transaction[]
}

model Transaction {
  id          Int             @id @default(autoincrement())
  montant     Float
  type        TypeTransaction
  date        DateTime        @default(now())
  description String

  // Foreign Keys
  compteId Int
  compte   Compte @relation("SourceAccount", fields: [compteId], references: [id])

  idDestination Int?
  destination   Compte? @relation("DestinationAccount", fields: [idDestination], references: [id])

  transferId Int?
  transfer   Transfer? @relation(fields: [transferId], references: [id])

  categorieId Int
  categorie   Categorie @relation(fields: [categorieId], references: [id])

  @@index([compteId, date, id, montant])
}

model BalanceSnapshot {
  id    Int      @id @default(autoincrement())
  date  DateTime // The date this "save point" was made
  solde Float // The calculated balance at that exact moment

  compteId Int
  compte   Compte @relation(fields: [compteId], references: [id])

  @@index([compteId, date]) // Important for finding the "latest" snapshot quickly
}
